#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

if [ -f .env.local ]; then
  export $(grep -v '^#' .env.local | xargs)
fi

# Conditionally skip hooks
if [ "$SKIP_HOOKS" = "true" ]; then
  echo "🔁 SKIP_HOOKS is true — skipping pre-commit checks"
  exit 0
fi

echo "🛡️  Starting pre-commit checks...\n\n"

# Step 1: Dependencies audit
echo "🔒 Step 1: Security audit..."
pnpm audit || exit_code=$?
if [ "$exit_code" ]; then
  echo "❌ PNPM audit found vulnerabilities."
  echo "💡 Run 'pnpm audit --fix' to automatically fix issues."
  exit 1
fi
echo "✅ Audit passed!\n\n"

# Step 2: Linting
echo "🧹 Step 2: Linting..."
pnpm lint || exit_code=$?
if [ "$exit_code" ]; then
  echo "❌ Lint failed."
  exit 1
fi
echo "✅ Lint passed!\n\n"

# Step 3: Type Checking
echo "📐 Step 3: Type checking..."
pnpm typecheck || exit_code=$?
if [ "$exit_code" ]; then
  echo "❌ Type check failed."
  exit 1
fi
echo "✅ Type check passed!\n\n"

# Step 4: Format Check
echo "🎨 Step 4: Format check..."
pnpm format:check || exit_code=$?
if [ "$exit_code" ]; then
  echo "❌ Format check failed."
  exit 1
fi
echo "✅ Format check passed!\n\n"

# Step 5: Tests
echo "🧪 Step 5: Running tests..."
pnpm test || exit_code=$?
if [ "$exit_code" ]; then
  echo "❌ Tests failed."
  exit 1
fi
echo "✅ All tests passed!\n\n"

echo "🎉 All checks completed — commit ready!"
exit 0
